/*!
 * PSPDFKit for Node.js 0.0.5 (https://pspdfkit.com/nodejs)
 *
 * Copyright (c) 2024 PSPDFKit GmbH. All rights reserved.
 *
 * THIS SOURCE CODE AND ANY ACCOMPANYING DOCUMENTATION ARE PROTECTED BY INTERNATIONAL COPYRIGHT LAW
 * AND MAY NOT BE RESOLD OR REDISTRIBUTED. USAGE IS BOUND TO THE PSPDFKIT LICENSE AGREEMENT.
 * UNAUTHORIZED REPRODUCTION OR DISTRIBUTION IS SUBJECT TO CIVIL AND CRIMINAL PENALTIES.
 * This notice may not be removed from this file.
 *
 * PSPDFKit uses several open source third-party components: https://pspdfkit.com/acknowledgements/nodejs/
 */var e=(E=function(e){if("u">typeof require)return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')},"u">typeof require?require:"u">typeof Proxy?new Proxy(E,{get:(e,t)=>("u">typeof require?require:e)[t]}):E),t={BUNDLE:"/vendor"},n=function e(t){let n;return Object.setPrototypeOf(n=t instanceof Error?t:Error(t),e.prototype),n};function r(e,t){if(!e)throw new n(`Assertion failed: ${t||"Condition not met"}

For further assistance, please go to: https://pspdfkit.com/support/request`)}function o(e){console.log(e)}function a(...e){console.warn(...e)}function i(e){console.error(e)}function s(e){return{name:e.name,scale:{unitFrom:e.scale.unitFrom,unitTo:e.scale.unitTo,from:Number(e.scale.fromValue),to:Number(e.scale.toValue)},precision:e.precision}}n.prototype=Object.create(Error.prototype,{name:{value:"PSPDFKitError",enumerable:!1}});var c="object"==typeof process&&"object"==typeof process.versions&&"u">typeof process.versions.node||"u">typeof window&&"Deno"in window||"u">typeof self&&"Deno"in self?function(t){return Promise.resolve(e(t))}:function(e){return"object"==typeof window?new Promise((t,n)=>{let o=document.createElement("script");o.type="text/javascript",o.async=!0,o.onload=()=>t(window.PSPDFModuleInit),o.onerror=n,o.src=e;let{documentElement:a}=document;r(a),a.appendChild(o)}):(self.importScripts(e),Promise.resolve(self.PSPDFModuleInit))},l=`${t.BUNDLE}/`,d=`${l}pspdfkit.wasm.js`,u=`${l}pspdfkit.wasm`;function p(e){let t=new FileReader;return new Promise((n,r)=>{t.onerror=e=>{r(Error(e))},t.onload=e=>{n(new Uint8Array(e.target?.result))},t.readAsArrayBuffer(e)})}var f={TEXT:"text"},m={documentA:"documentA",documentB:"documentB",result:"result"},g={Maui_Android:"Maui_Android",Maui_iOS:"Maui_iOS",Maui_MacCatalyst:"Maui_MacCatalyst",Maui_Windows:"Maui_Windows",FlutterForWeb:"FlutterForWeb",Electron:"Electron"},h={cms:"cms",cades:"cades"},y={unableToShape:"unableToShape",requiresMoreFonts:"requiresMoreFonts"};async function _(e){try{let t=await fetch(e).catch(t=>{throw new n(`Error fetching dynamic fonts file ${e}. ${t}`)});if(200!==t.status)throw new n(`Error fetching dynamic fonts file ${e}. Status code: ${t.status}`);return await t.json().catch(t=>{throw new n(`Error parsing dynamic fonts file ${e}. ${t}`)})}catch(e){throw e}}function b(e=globalThis.navigator?.userAgent??""){return e.indexOf("Trident/")>-1?"trident":e.indexOf("Edge/")>-1?"edge":e.indexOf("Chrome/")>-1?"blink":e.indexOf("AppleWebKit/")>-1?"webkit":e.indexOf("Gecko/")>-1?"gecko":"unknown"}function w(e,t){let n=RegExp(` ${t}/(\\d+)\\.*`),r;return(r=e.match(n))?Number(r[1]):0}function O(e=globalThis.navigator?.userAgent??"",t=globalThis.navigator?.platform??"",n=globalThis.navigator?.maxTouchPoints??0){return t.indexOf("MacIntel")>-1&&n>1?"ios":e.indexOf("Win")>-1?"windows":e.indexOf("iPhone")>-1||e.indexOf("iPad")>-1||"iPad"===t?"ios":e.indexOf("Mac")>-1?"macos":e.indexOf("Android")>-1?"android":e.indexOf("Linux")>-1?"linux":"unknown"}b();var x=O();(function(e=globalThis.navigator?.userAgent){switch(b(e)){case"trident":return w(e,"Trident");case"edge":return w(e,"Edge");case"blink":return w(e,"Chrome");case"webkit":return w(e,"Version");case"gecko":return w(e,"Firefox");default:return 0}})(),function(e=O(),t=b()){"ios"===e||"android"===e||I(t)}(),"ios"===x||I();var F="ios"===x;function I(e=b()){return!("u">typeof window&&window.PSPDFKIT_PLAYWRIGHT_TEST||globalThis.navigator?.userAgent.indexOf("jsdom/")>=0)&&"webkit"===e&&"u">typeof TouchEvent}"u">typeof window&&(window.addEventListener("mousemove",function e(){window.removeEventListener("mousemove",e)}),window.addEventListener("pointermove",function e(t){"mouse"===t.pointerType||t.pointerType,window.removeEventListener("pointermove",e)})),/Mac/i.test(globalThis.navigator?.platform);var E,v,S="/create.pdf",k="/save.pdf",A="/embedded.pdf",D="WebAssembly module not loaded.",j=null,B=!1,P=!1,T=null,$=[],C=null,N=null,R=null,J=new Set,U="/fonts",M=new Set;function L(e){return null!=e&&null!=e.length&&0===e.length}var q=["configurePDFJavaScriptSupport","closeDocument","setFormValues","openDocument","saveDocument","importXFDF","importInstantDocumentJSON"],z={annotationsAndForms:"annotations_and_forms",assemble:"assemble",extract:"extract",extractAccessibility:"extract_accessibility",fillForms:"fill_forms",modification:"modification",printHighQuality:"print_high_quality",printing:"printing"};function V(e,...t){r(j,"WebAssembly module not loaded."),r(j[e],`Native module does not implement ${e}.`);let n=t.map(e=>L(e)?JSON.stringify(e):e);q.includes(e)&&en();let o=JSON.parse(j[e](...n)||'{ "success": true }');if(!o.success)throw Error(o.error);return o}function W(e,...t){r(j,"WebAssembly module not loaded."),r(j[e],`Native module does not implement ${e}.`),q.includes(e)&&en();let n=t.map(e=>L(e)?JSON.stringify(e):e);return j[e](...n)}var G=["run_pdf_formatting_scripts","run_pdf_javascript","set_form_values_get_script_changes","edit_document","prepare_sign","sign","on_keystroke_event","save_document","update_annotation"];function K(e,t={},n=null){let o;r(j,"WebAssembly module not loaded.");let a=JSON.stringify({type:e,...t});if(G.includes(e)&&en(),n)try{let e=new Uint8Array("string"==typeof n?function(e){let t=new ArrayBuffer(2*e.length),n=new Uint16Array(t);for(let t=0,r=e.length;t<r;t++)n[t]=e.charCodeAt(t);return t}(n):n),t=j.allocateMemory(e.byteLength);try{t.view.set(e);let n=j.memoryHandleToVector(t);try{o=j.dispatchCommandWithBinary(a,n)}finally{n.delete()}}finally{t.delete()}}catch(e){throw e}else o=j.dispatchCommand(a);if(o.hasError()){let t=Error(o.getErrorMessage()||"There was an error while executing the command: "+e);throw o.delete(),t}let i=[];for(let e=0;e<o.getRepliesCount();e++)o.hasJSONReply(e)&&i.push(JSON.parse(o.getJSONReply(e))),o.hasBinaryReply(e)&&i.push(o.getBinaryReply(e).slice(0));return o.delete(),i}function Y(e,t){return`${e}/${t}.pdf`}async function H(e,t){let n=Math.random().toString(36).slice(-5),o=await Promise.all(Object.entries(t).map(async([t,r])=>(e.forEach(e=>{"document"in e&&e.document===t&&"importDocument"===e.type?(!1===e.treatImportedDocumentAsOnePage&&(e.treatImportedDocumentAsOnePage=void 0),e.document=Y(n,t)):("dataFilePath"in e&&e.dataFilePath===t&&"applyInstantJson"===e.type||"dataFilePath"in e&&e.dataFilePath===t&&"applyXfdf"===e.type)&&(e.dataFilePath=Y(n,t))}),{basename:t,buffer:await p(r)})));return o.forEach(e=>{var t,o;t=e.basename,o=e.buffer,r(j,D),j.FS.analyzePath(n).exists||j.FS.mkdir(n),j.FS.writeFile(Y(n,t),o)}),function(){o.forEach(e=>{var t;t=e.basename,r(j,D),j.FS.unlink(Y(n,t))})}}function Z(){P=!0;let e=V("configurePDFJavaScriptSupport",!0);return r(e.success,"An error occurred while executing the document level JavaScript."),e.changes||[]}function X(e,t){let n;try{n=K("edit_document",{save_path:t,operations:e})}catch(e){throw Error(`Error applying operations to document: ${e.message}`)}return n}var Q,ee=null,et=!1;function en(){et||(ee=null,Q=!1)}function er(e){et&&!e&&(et=!1,ee&&ea(ee)),et=e}function eo(){return null===ee&&(ee=K("read_form_json_objects",{include_line_height_factor:!1}),Q=!1),ee}function ea(e){if(et){if(null===e)throw et=!1,Error("Error enqueuing form JSON objects: form fields JSON is null.");ee&&!Q&&(Q=!0),ee=e;return}if(Q||!et)try{en(),K("apply_form_json_objects",{form_fields_with_widgets:e})}catch(e){throw Error("Error applying form JSON objects to "+S+": "+e.message)}}function ei(e,t,n,o,i,s){let c=ec(i,{width:n,height:o});if(r("number"==typeof e.pageIndex,"Annotation must have a pageIndex"),!J.has(e.pdfObjectId))try{return r("number"==typeof e.pdfObjectId,"Cannot call renderAnnotation() for an annotation without pdfObjectId."),K("render_annotation",{page:e.pageIndex,annotation_id:e.pdfObjectId,format:c,bitmap_width:n,bitmap_height:o,appearance_stream_type:s||"normal"})[0]}catch(e){a(e.message);return}}var es={SharePoint:"SPO",Salesforce:"SF",[g.Maui_iOS]:"MauiIOS",[g.Maui_Android]:"MauiAndroid",[g.Maui_MacCatalyst]:"MauiMacCatalyst",[g.Maui_Windows]:"MauiWindows",[g.FlutterForWeb]:"FlutterForWeb",NodeJS:"NodeJS",Electron:"Electron"};function ec(e,{width:t,height:n}){return"webp"===e&&(t>16383||n>16383)||F&&t*n>16777216&&"bitmap"===e?"png":e}function el(e,t){return e.pdfObjectId===t.pdfObjectId}async function ed({buffer:e,width:t,height:n}){let o=await self.createImageBitmap(new ImageData(new Uint8ClampedArray(e),t,n),0,0,t,n),a=new OffscreenCanvas(t,n),i=a.getContext("bitmaprenderer");r(i),i.transferFromImageBitmap(o);let s=await a.convertToBlob(),c=URL.createObjectURL(s);return o.close(),c}var eu=new class{constructor(){this._pdfObjectIdsForIds={},this.comparisonDocuments={},this.lastOpenedComparisonDocument=null,this.persistedOpenDocument=null}loadNativeModule(n,{disableWebAssemblyStreaming:r,enableAutomaticLinkExtraction:s,overrideMemoryLimit:l}){return N=Date.now(),B=s,T=l,(function(n,r,s=globalThis){let l,p;return new Promise(async r=>{l="object"==typeof n?{wasmBinaryFile:u,locateFile:e=>e,wasmBinary:n.wasm}:{wasmBinaryFile:n+u,locateFile:e=>e,wasmBinary:e("fs").readFileSync("./vendor/pspdfkit.wasm")},p="string"==typeof n?await c(`${n}${d}`):(await import(n.wasmLoaderPath)).default,o("Using WASM method"),s.PSPDFLoggingServices={error(e,t){i(`[${e}] ${t}`)},warn(e,t){a(`[${e}] ${t}`)},info(e,n){t.INTERNAL_DEBUG&&o(`[${e}] ${n}`)},debug(e,n){t.INTERNAL_DEBUG&&o(`[${e}] ${n}`)},trace(e,n){t.INTERNAL_DEBUG&&o(`[${e}] ${n}`)}},s.PSPDFUnicodeServices={stripDiacritics(e){let t={Á:"A",Ă:"A",Ắ:"A",Ặ:"A",Ằ:"A",Ẳ:"A",Ẵ:"A",Ǎ:"A",Â:"A",Ấ:"A",Ậ:"A",Ầ:"A",Ẩ:"A",Ẫ:"A",Ä:"A",Ǟ:"A",Ȧ:"A",Ǡ:"A",Ạ:"A",Ȁ:"A",À:"A",Ả:"A",Ȃ:"A",Ā:"A",Ą:"A",Å:"A",Ǻ:"A",Ḁ:"A",Ⱥ:"A",Ã:"A",Ꜳ:"AA",Æ:"AE",Ǽ:"AE",Ǣ:"AE",Ꜵ:"AO",Ꜷ:"AU",Ꜹ:"AV",Ꜻ:"AV",Ꜽ:"AY",Ḃ:"B",Ḅ:"B",Ɓ:"B",Ḇ:"B",Ƀ:"B",Ƃ:"B",Ć:"C",Č:"C",Ç:"C",Ḉ:"C",Ĉ:"C",Ċ:"C",Ƈ:"C",Ȼ:"C",Ď:"D",Ḑ:"D",Ḓ:"D",Ḋ:"D",Ḍ:"D",Ɗ:"D",Ḏ:"D",ǲ:"D",ǅ:"D",Đ:"D",Ƌ:"D",Ǳ:"DZ",Ǆ:"DZ",É:"E",Ĕ:"E",Ě:"E",Ȩ:"E",Ḝ:"E",Ê:"E",Ế:"E",Ệ:"E",Ề:"E",Ể:"E",Ễ:"E",Ḙ:"E",Ë:"E",Ė:"E",Ẹ:"E",Ȅ:"E",È:"E",Ẻ:"E",Ȇ:"E",Ē:"E",Ḗ:"E",Ḕ:"E",Ę:"E",Ɇ:"E",Ẽ:"E",Ḛ:"E",Ꝫ:"ET",Ḟ:"F",Ƒ:"F",Ǵ:"G",Ğ:"G",Ǧ:"G",Ģ:"G",Ĝ:"G",Ġ:"G",Ɠ:"G",Ḡ:"G",Ǥ:"G",Ḫ:"H",Ȟ:"H",Ḩ:"H",Ĥ:"H",Ⱨ:"H",Ḧ:"H",Ḣ:"H",Ḥ:"H",Ħ:"H",Í:"I",Ĭ:"I",Ǐ:"I",Î:"I",Ï:"I",Ḯ:"I",İ:"I",Ị:"I",Ȉ:"I",Ì:"I",Ỉ:"I",Ȋ:"I",Ī:"I",Į:"I",Ɨ:"I",Ĩ:"I",Ḭ:"I",Ꝺ:"D",Ꝼ:"F",Ᵹ:"G",Ꞃ:"R",Ꞅ:"S",Ꞇ:"T",Ꝭ:"IS",Ĵ:"J",Ɉ:"J",Ḱ:"K",Ǩ:"K",Ķ:"K",Ⱪ:"K",Ꝃ:"K",Ḳ:"K",Ƙ:"K",Ḵ:"K",Ꝁ:"K",Ꝅ:"K",Ĺ:"L",Ƚ:"L",Ľ:"L",Ļ:"L",Ḽ:"L",Ḷ:"L",Ḹ:"L",Ⱡ:"L",Ꝉ:"L",Ḻ:"L",Ŀ:"L",Ɫ:"L",ǈ:"L",Ł:"L",Ǉ:"LJ",Ḿ:"M",Ṁ:"M",Ṃ:"M",Ɱ:"M",Ń:"N",Ň:"N",Ņ:"N",Ṋ:"N",Ṅ:"N",Ṇ:"N",Ǹ:"N",Ɲ:"N",Ṉ:"N",Ƞ:"N",ǋ:"N",Ñ:"N",Ǌ:"NJ",Ó:"O",Ŏ:"O",Ǒ:"O",Ô:"O",Ố:"O",Ộ:"O",Ồ:"O",Ổ:"O",Ỗ:"O",Ö:"O",Ȫ:"O",Ȯ:"O",Ȱ:"O",Ọ:"O",Ő:"O",Ȍ:"O",Ò:"O",Ỏ:"O",Ơ:"O",Ớ:"O",Ợ:"O",Ờ:"O",Ở:"O",Ỡ:"O",Ȏ:"O",Ꝋ:"O",Ꝍ:"O",Ō:"O",Ṓ:"O",Ṑ:"O",Ɵ:"O",Ǫ:"O",Ǭ:"O",Ø:"O",Ǿ:"O",Õ:"O",Ṍ:"O",Ṏ:"O",Ȭ:"O",Ƣ:"OI",Ꝏ:"OO",Ɛ:"E",Ɔ:"O",Ȣ:"OU",Ṕ:"P",Ṗ:"P",Ꝓ:"P",Ƥ:"P",Ꝕ:"P",Ᵽ:"P",Ꝑ:"P",Ꝙ:"Q",Ꝗ:"Q",Ŕ:"R",Ř:"R",Ŗ:"R",Ṙ:"R",Ṛ:"R",Ṝ:"R",Ȑ:"R",Ȓ:"R",Ṟ:"R",Ɍ:"R",Ɽ:"R",Ꜿ:"C",Ǝ:"E",Ś:"S",Ṥ:"S",Š:"S",Ṧ:"S",Ş:"S",Ŝ:"S",Ș:"S",Ṡ:"S",Ṣ:"S",Ṩ:"S",Ť:"T",Ţ:"T",Ṱ:"T",Ț:"T",Ⱦ:"T",Ṫ:"T",Ṭ:"T",Ƭ:"T",Ṯ:"T",Ʈ:"T",Ŧ:"T",Ɐ:"A",Ꞁ:"L",Ɯ:"M",Ʌ:"V",Ꜩ:"TZ",Ú:"U",Ŭ:"U",Ǔ:"U",Û:"U",Ṷ:"U",Ü:"U",Ǘ:"U",Ǚ:"U",Ǜ:"U",Ǖ:"U",Ṳ:"U",Ụ:"U",Ű:"U",Ȕ:"U",Ù:"U",Ủ:"U",Ư:"U",Ứ:"U",Ự:"U",Ừ:"U",Ử:"U",Ữ:"U",Ȗ:"U",Ū:"U",Ṻ:"U",Ų:"U",Ů:"U",Ũ:"U",Ṹ:"U",Ṵ:"U",Ꝟ:"V",Ṿ:"V",Ʋ:"V",Ṽ:"V",Ꝡ:"VY",Ẃ:"W",Ŵ:"W",Ẅ:"W",Ẇ:"W",Ẉ:"W",Ẁ:"W",Ⱳ:"W",Ẍ:"X",Ẋ:"X",Ý:"Y",Ŷ:"Y",Ÿ:"Y",Ẏ:"Y",Ỵ:"Y",Ỳ:"Y",Ƴ:"Y",Ỷ:"Y",Ỿ:"Y",Ȳ:"Y",Ɏ:"Y",Ỹ:"Y",Ź:"Z",Ž:"Z",Ẑ:"Z",Ⱬ:"Z",Ż:"Z",Ẓ:"Z",Ȥ:"Z",Ẕ:"Z",Ƶ:"Z",Ĳ:"IJ",Œ:"OE",ᴀ:"A",ᴁ:"AE",ʙ:"B",ᴃ:"B",ᴄ:"C",ᴅ:"D",ᴇ:"E",ꜰ:"F",ɢ:"G",ʛ:"G",ʜ:"H",ɪ:"I",ʁ:"R",ᴊ:"J",ᴋ:"K",ʟ:"L",ᴌ:"L",ᴍ:"M",ɴ:"N",ᴏ:"O",ɶ:"OE",ᴐ:"O",ᴕ:"OU",ᴘ:"P",ʀ:"R",ᴎ:"N",ᴙ:"R",ꜱ:"S",ᴛ:"T",ⱻ:"E",ᴚ:"R",ᴜ:"U",ᴠ:"V",ᴡ:"W",ʏ:"Y",ᴢ:"Z",á:"a",ă:"a",ắ:"a",ặ:"a",ằ:"a",ẳ:"a",ẵ:"a",ǎ:"a",â:"a",ấ:"a",ậ:"a",ầ:"a",ẩ:"a",ẫ:"a",ä:"a",ǟ:"a",ȧ:"a",ǡ:"a",ạ:"a",ȁ:"a",à:"a",ả:"a",ȃ:"a",ā:"a",ą:"a",ᶏ:"a",ẚ:"a",å:"a",ǻ:"a",ḁ:"a",ⱥ:"a",ã:"a",ꜳ:"aa",æ:"ae",ǽ:"ae",ǣ:"ae",ꜵ:"ao",ꜷ:"au",ꜹ:"av",ꜻ:"av",ꜽ:"ay",ḃ:"b",ḅ:"b",ɓ:"b",ḇ:"b",ᵬ:"b",ᶀ:"b",ƀ:"b",ƃ:"b",ɵ:"o",ć:"c",č:"c",ç:"c",ḉ:"c",ĉ:"c",ɕ:"c",ċ:"c",ƈ:"c",ȼ:"c",ď:"d",ḑ:"d",ḓ:"d",ȡ:"d",ḋ:"d",ḍ:"d",ɗ:"d",ᶑ:"d",ḏ:"d",ᵭ:"d",ᶁ:"d",đ:"d",ɖ:"d",ƌ:"d",ı:"i",ȷ:"j",ɟ:"j",ʄ:"j",ǳ:"dz",ǆ:"dz",é:"e",ĕ:"e",ě:"e",ȩ:"e",ḝ:"e",ê:"e",ế:"e",ệ:"e",ề:"e",ể:"e",ễ:"e",ḙ:"e",ë:"e",ė:"e",ẹ:"e",ȅ:"e",è:"e",ẻ:"e",ȇ:"e",ē:"e",ḗ:"e",ḕ:"e",ⱸ:"e",ę:"e",ᶒ:"e",ɇ:"e",ẽ:"e",ḛ:"e",ꝫ:"et",ḟ:"f",ƒ:"f",ᵮ:"f",ᶂ:"f",ǵ:"g",ğ:"g",ǧ:"g",ģ:"g",ĝ:"g",ġ:"g",ɠ:"g",ḡ:"g",ᶃ:"g",ǥ:"g",ḫ:"h",ȟ:"h",ḩ:"h",ĥ:"h",ⱨ:"h",ḧ:"h",ḣ:"h",ḥ:"h",ɦ:"h",ẖ:"h",ħ:"h",ƕ:"hv",í:"i",ĭ:"i",ǐ:"i",î:"i",ï:"i",ḯ:"i",ị:"i",ȉ:"i",ì:"i",ỉ:"i",ȋ:"i",ī:"i",į:"i",ᶖ:"i",ɨ:"i",ĩ:"i",ḭ:"i",ꝺ:"d",ꝼ:"f",ᵹ:"g",ꞃ:"r",ꞅ:"s",ꞇ:"t",ꝭ:"is",ǰ:"j",ĵ:"j",ʝ:"j",ɉ:"j",ḱ:"k",ǩ:"k",ķ:"k",ⱪ:"k",ꝃ:"k",ḳ:"k",ƙ:"k",ḵ:"k",ᶄ:"k",ꝁ:"k",ꝅ:"k",ĺ:"l",ƚ:"l",ɬ:"l",ľ:"l",ļ:"l",ḽ:"l",ȴ:"l",ḷ:"l",ḹ:"l",ⱡ:"l",ꝉ:"l",ḻ:"l",ŀ:"l",ɫ:"l",ᶅ:"l",ɭ:"l",ł:"l",ǉ:"lj",ſ:"s",ẜ:"s",ẛ:"s",ẝ:"s",ḿ:"m",ṁ:"m",ṃ:"m",ɱ:"m",ᵯ:"m",ᶆ:"m",ń:"n",ň:"n",ņ:"n",ṋ:"n",ȵ:"n",ṅ:"n",ṇ:"n",ǹ:"n",ɲ:"n",ṉ:"n",ƞ:"n",ᵰ:"n",ᶇ:"n",ɳ:"n",ñ:"n",ǌ:"nj",ó:"o",ŏ:"o",ǒ:"o",ô:"o",ố:"o",ộ:"o",ồ:"o",ổ:"o",ỗ:"o",ö:"o",ȫ:"o",ȯ:"o",ȱ:"o",ọ:"o",ő:"o",ȍ:"o",ò:"o",ỏ:"o",ơ:"o",ớ:"o",ợ:"o",ờ:"o",ở:"o",ỡ:"o",ȏ:"o",ꝋ:"o",ꝍ:"o",ⱺ:"o",ō:"o",ṓ:"o",ṑ:"o",ǫ:"o",ǭ:"o",ø:"o",ǿ:"o",õ:"o",ṍ:"o",ṏ:"o",ȭ:"o",ƣ:"oi",ꝏ:"oo",ɛ:"e",ᶓ:"e",ɔ:"o",ᶗ:"o",ȣ:"ou",ṕ:"p",ṗ:"p",ꝓ:"p",ƥ:"p",ᵱ:"p",ᶈ:"p",ꝕ:"p",ᵽ:"p",ꝑ:"p",ꝙ:"q",ʠ:"q",ɋ:"q",ꝗ:"q",ŕ:"r",ř:"r",ŗ:"r",ṙ:"r",ṛ:"r",ṝ:"r",ȑ:"r",ɾ:"r",ᵳ:"r",ȓ:"r",ṟ:"r",ɼ:"r",ᵲ:"r",ᶉ:"r",ɍ:"r",ɽ:"r",ↄ:"c",ꜿ:"c",ɘ:"e",ɿ:"r",ś:"s",ṥ:"s",š:"s",ṧ:"s",ş:"s",ŝ:"s",ș:"s",ṡ:"s",ṣ:"s",ṩ:"s",ʂ:"s",ᵴ:"s",ᶊ:"s",ȿ:"s",ɡ:"g",ᴑ:"o",ᴓ:"o",ᴝ:"u",ť:"t",ţ:"t",ṱ:"t",ț:"t",ȶ:"t",ẗ:"t",ⱦ:"t",ṫ:"t",ṭ:"t",ƭ:"t",ṯ:"t",ᵵ:"t",ƫ:"t",ʈ:"t",ŧ:"t",ᵺ:"th",ɐ:"a",ᴂ:"ae",ǝ:"e",ᵷ:"g",ɥ:"h",ʮ:"h",ʯ:"h",ᴉ:"i",ʞ:"k",ꞁ:"l",ɯ:"m",ɰ:"m",ᴔ:"oe",ɹ:"r",ɻ:"r",ɺ:"r",ⱹ:"r",ʇ:"t",ʌ:"v",ʍ:"w",ʎ:"y",ꜩ:"tz",ú:"u",ŭ:"u",ǔ:"u",û:"u",ṷ:"u",ü:"u",ǘ:"u",ǚ:"u",ǜ:"u",ǖ:"u",ṳ:"u",ụ:"u",ű:"u",ȕ:"u",ù:"u",ủ:"u",ư:"u",ứ:"u",ự:"u",ừ:"u",ử:"u",ữ:"u",ȗ:"u",ū:"u",ṻ:"u",ų:"u",ᶙ:"u",ů:"u",ũ:"u",ṹ:"u",ṵ:"u",ᵫ:"ue",ꝸ:"um",ⱴ:"v",ꝟ:"v",ṿ:"v",ʋ:"v",ᶌ:"v",ⱱ:"v",ṽ:"v",ꝡ:"vy",ẃ:"w",ŵ:"w",ẅ:"w",ẇ:"w",ẉ:"w",ẁ:"w",ⱳ:"w",ẘ:"w",ẍ:"x",ẋ:"x",ᶍ:"x",ý:"y",ŷ:"y",ÿ:"y",ẏ:"y",ỵ:"y",ỳ:"y",ƴ:"y",ỷ:"y",ỿ:"y",ȳ:"y",ẙ:"y",ɏ:"y",ỹ:"y",ź:"z",ž:"z",ẑ:"z",ʑ:"z",ⱬ:"z",ż:"z",ẓ:"z",ȥ:"z",ẕ:"z",ᵶ:"z",ᶎ:"z",ʐ:"z",ƶ:"z",ɀ:"z",ﬀ:"ff",ﬃ:"ffi",ﬄ:"ffl",ﬁ:"fi",ﬂ:"fl",ĳ:"ij",œ:"oe",ﬆ:"st",ₐ:"a",ₑ:"e",ᵢ:"i",ⱼ:"j",ₒ:"o",ᵣ:"r",ᵤ:"u",ᵥ:"v",ₓ:"x"};if(!e.normalize)return e;let n=e.replace(/[^A-Za-z0-9[\] ]/g,function(e){return t[e]||e});return e.normalize("NFC").length==n.normalize("NFC").length?n:""},escapeRegExp:e=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),match(e,t,n){let r=new RegExp(t,n?"g":"gi"),o=[],a=r.exec(e);for(;null!=a;)o.push([a.index,a[0].length]),a=r.exec(e);return o},exec:(e,t)=>new RegExp(e).exec(t)},r({nativeModule:await p(l)})})})(n,0).then(({nativeModule:e})=>{j=e;let n=V("PSPDFKitVersion").version;if(1!==n)throw Error(`Native version mismatch. Please update the dependencies. Expected 1 but got ${n}.`);t.INTERNAL_DEBUG&&V("setLogLevel","debug")})}async load(e,t,{mainThreadOrigin:n,customFonts:a,dynamicFonts:i,productId:s}){let c;r(j,D);try{var l;if(j.FS.analyzePath(U).exists||j.FS.mkdir(U),v=a?`${U}/custom-fonts`:"",a&&!j.FS.analyzePath(v).exists&&(l=v,r(j,D),j.FS.analyzePath(l).exists||j.FS.mkdir(l),a.forEach(e=>{j.FS.writeFile(`${l}/${e.name}`,new Uint8Array(e.data))})),"object"==typeof navigator&&"string"==typeof navigator.userAgent&&navigator.userAgent.indexOf("Electron/")>=0&&(r(null==s||s===g.Electron,`PSPDFKit is running on Electron, but has been setup to be used with ${s}Please contact support to resolve the issue.`),s=g.Electron),c=j.initPSPDFKit(t??"",n,U,"",s&&"u">typeof es[s]?es[s]:""),i){let e=await _(i);K("dynamic_font_loading/set_metadata_file",{metadata:e}),R=i.split("/").slice(0,-1).join("/")}}catch(e){throw e}let d=JSON.parse(c);if(N&&o(`Native initialization complete, took: ${Date.now()-N}ms`),!d.success)throw Error("Failed to initialize PSPDFKit: "+d.error);return d}async openDocument(e,t,n){try{return r(j,D),null!==T&&V("overrideMemoryLimit",T),C=t,j.FS.writeFile(S,new Uint8Array(e)),this.openAndReturnDocumentInfo(n)}finally{this._pdfObjectIdsForIds={}}}async getSuggestedLineHeightFactor(e,t){return K("get_suggested_line_height_factor",{annotation_ids:[e],page:t})[0].line_height_factors[e.toString()]}async getAvailableFontFaces(e){return e?K("get_available_font_faces")[0]?.font_faces.reduce((t,n)=>{let r=e.find(e=>e.name===n.path.replace(`${v}/`,""));return r?t.concat({readableName:n.fullName,name:r.name}):t},[]):[]}async setFontSubstitutions(e){try{K("set_font_substitutions",{substitutions:e})}catch(e){throw Error("Error setting fonts substitutions: "+e.message)}}async getClosestSnapPoint(e,t){return K("get_closest_snap",{q:[e,t]})[0]}async configureSnapper(e){K("configure_snapper",{page:e})}async reloadDocument(){try{return er(!1),V("closeDocument"),this.openAndReturnDocumentInfo()}finally{this._pdfObjectIdsForIds={}}}async openAndReturnDocumentInfo(e){V("openDocument",S,JSON.stringify({password:C})),P&&Z(),V("automaticLinkExtraction",B);let t=V("getDocumentInfo").documentInfo;if(t.pageCount<=0)return t;let n=[];if("number"==typeof e){let r=await this.getPageInfo(e);for(let o=0;o<t.pageCount;o++){let t={...r,pageIndex:o,pageLabel:e===o?r.pageLabel:String(o+1)};n.push(t)}}else n=await this.getAllPageInfos(t.pageCount);return t.pages=n,t}async getPageInfo(e){try{let t=K("page_info",{query:"page_info",page:e});r(1===t.length,"expected page_info result to return 1 result when specifying index.");let n=new TextDecoder().decode(t[0]);return JSON.parse(n).pageInfo}catch{return i(`Dimensional information for page ${e} unavailable, page will not be displayed.`),{height:0,matrix:[0,0,0,0,0,0],pageLabel:"",reverseMatrix:[0,0,0,0,0,0],transformedBBox:[0,0,0,0],untransformedBBox:[0,0,0,0],width:0,pageIndex:e,rawPdfBoxes:{bleedBox:null,cropBox:null,mediaBox:null,trimBox:null}}}}async preflightRenderAnnotationText(e,t,n,o){let a=()=>"number"==typeof t&&"number"==typeof n?K("dynamic_font_loading/preflight_annotation",{text:e,annotation_id:t,page:n})[0]:(r(o,`annotation not set: ${o}`),K("dynamic_font_loading/preflight_annotation",{text:e,annotation_json:o})[0]);try{let e=a();e.preflight_result===y.requiresMoreFonts&&(await this.addDynamicFonts(e.required_fonts),e=a()),"number"==typeof t&&(e.preflight_result===y.unableToShape?J.add(t):J.delete(t))}catch(n){i(`There was an error testing rendering for annotation ${t} of this text: ${e}: ${n.message}`)}}async addDynamicFonts(e){let t=[];try{var n;t=e.filter(e=>!M.has(e)),n=(await Promise.all(t.map(e=>fetch(`${R}/${e}`).then(e=>e.arrayBuffer())))).map((e,n)=>({name:t[n],data:e})),r(j,D),n.forEach(e=>{j.FS.analyzePath(`${U}/${e.name}`).exists||j.FS.writeFile(`${U}/${e.name}`,new Uint8Array(e.data))}),t.forEach(e=>{M.add(e)})}catch(e){t.forEach(e=>{M.delete(e)}),i(`There was an error loading a font: ${e}`)}await K("dynamic_font_loading/notify_fonts_added",{added_fonts:t.map(e=>({remote_file_path:e,local_file_name:e}))})}async getAllPageInfos(e){let t=[];try{let n=K("page_info",{query:"page_info",page:"all"});r(n.length===e,"expected the same length of page info response to page count.");for(let e=0;e<n.length;e++){let r=new TextDecoder().decode(n[e]),o=JSON.parse(r);t.push(o.pageInfo)}}catch{i("There was an error retrieving page information for all pages from core. Reverting to individual queries.");for(let n=0;n<e;n++)try{let e=K("page_info",{query:"page_info",page:n});r(1===e.length,"expected page_info result to return 1 result when specifying index.");let o=new TextDecoder().decode(e[0]),a=JSON.parse(o);t.push(a.pageInfo)}catch{i(`Dimensional information for page ${n} unavailable, page will not be displayed.`);let e={height:0,matrix:[0,0,0,0,0,0],pageLabel:"",reverseMatrix:[0,0,0,0,0,0],transformedBBox:[0,0,0,0],untransformedBBox:[0,0,0,0],width:0,pageIndex:n,rawPdfBoxes:{bleedBox:null,cropBox:null,mediaBox:null,trimBox:null}};t.push(e)}}return t}async enablePDFJavaScriptSupport(){return Z()}async runPDFFormattingScripts(e,t){let n;r(P,"PDF Formatting Scripts can only run after JavaScript is enabled.");try{n=K("run_pdf_formatting_scripts",{form_fqns:e,only_if_no_ap_stream:t})}catch(e){throw Error(`An error occurred while executing the document level JavaScript formatting.

`+e.message)}return n[0].changes||[]}async openDocumentAt(){throw Error("Should never be called")}async getBookmarks(){let e=K("get_bookmarks");return r(1===e.length,"expected only one response for getBookmarks"),e[0].bookmarks||[]}async getFormJSON(){return V("getFormJSON").formJSON}async getFormValues(){return V("getFormValues").formValues}async setFormValues(e){let t=eo(),n=!1,r=[],o=t.map(t=>{let o=e.find(e=>e.name===t.formField.name);return o?o.value===t.value||Array.isArray(o.value)&&Array.isArray(t.value)&&o.value.every((e,n)=>e===t.value[n])?t:("string"==typeof o.value&&o.value.length>0?r.push({widgets:t.widgets,text:o.value}):t.widgets.forEach(e=>{"number"==typeof e.pdfObjectId&&J.delete(e.pdfObjectId)}),n=!0,{...t,value:o.value}):t});if(n){if(R)for(let e=0;e<r.length;e++){let t=r[e].widgets;for(let n=0;n<t.length;n++)await this.preflightWidgetAnnotation(t[n],t[n].pdfObjectId,r[e].text)}ea(o)}}async setFormFieldValue(e){await this.setFormValues([e])}async applyOperations(e,t){let n=await H(e,t);X(e,S),n()}async exportPDFWithOperations(e,t){let n=await H(e,t),o;r(j,D);try{X(e,k),o=j.FS.readFile(k).buffer}catch(e){throw Error("Error applying operations: "+e.message)}return n(),o}async getSignaturesInfo(){try{return K("get_signatures",{certificate_check_time:"current_time"})[0]}catch(e){throw Error(`Error getting signatures info: ${e.message}`)}}async getComments(){try{return K("get_comments")}catch(e){throw Error(`Error getting comments: ${e.message}`)}}async applyComments(e){try{return K("apply_comments",{comments:e})}catch(e){throw Error(`Error applying comments: ${e.message}`)}}async prepareSign(e,t,n,o,a,i,s){let c,l;try{l=K("get_signatures",{certificate_check_time:"current_time"})[0];let e="not_signed"!==l.status;V("saveDocument",k,!1,e,!1,!1,"pdf",!1),V("openDocument",k,JSON.stringify({password:C}))}catch(e){throw Error(`Error saving document backup for invisible signing: ${e}`)}try{let e=!n&&"not_signed"!==l.status;V("saveDocument",S,n,e,!1,!1,"pdf",!1),n&&(V("openDocument",S,JSON.stringify({password:C})),P&&Z())}catch(e){throw Error(`Error saving document for invisible signing: ${e}`)}try{c=K("prepare_sign",{signer_data_source:{...e,field_name:o,position:a,appearance:i,type:"pspdfkit/signer-data-source"},signature_metadata:{...t,type:"pspdfkit/signature-metadata"}},s)}catch(e){throw Error(`Error preparing document for signing: ${e}`)}r(j,D);let d=null;return e&&e?.signatureType!==h.cms||(d=j.FS.readFile(c[0].result.file_contents).buffer),j.FS.unlink(c[0].result.file_contents),{file:c[0].result.file,hash:c[0].result.hash,signatureFormFieldName:c[0].result.signature_form_fqn,dataToBeSigned:c[0].result.data_to_be_signed,fileContents:d}}async getTimestampRequest(e,t){try{let[n]=K("get_timestamp_http_request",{timestamp_authority_info:{url:t.url,authenticationInfo:{username:t.username,password:t.password}},data_to_timestamp:e});return{url:n.url,method:n.method,requestData:n.request_data,contentType:n.content_type,token:n.token,username:n.user,password:n.password}}catch(e){throw Error(`Error getting timestamp request: ${e.message}`)}}async getRevocationRequests(e){try{return K("get_revocation_http_requests",{signing_certificates:e})}catch(e){throw Error(`Error getting revocations requests: ${e.message}`)}}async setSignaturesLTV(e){try{let t=K("get_signatures",{certificate_check_time:"current_time",revocation_responses:e})[0];return V("saveDocument",S,!1,!0,!1,!1,"pdf",!1),t}catch(e){throw Error(`Error getting signatures info: ${e.message}`)}}async sign(e,t,n,r,o,a,i,s){let c;try{let l;r===h.cades&&Array.isArray(a)&&a.length>0&&(l=K("create_signature",{signatureType:r,hash:n,signed_data:o,certificates:a,timestamp_response:i})),c=K("sign",{password:C,save_path:S,file_path:e,signature_form_fqn:t,pkcs7_container:l?.[0].result||o,revocation_responses:s??[]}),V("openDocument",S,JSON.stringify({password:C})),P&&Z()}catch(e){throw Error(`Error signing document: ${e}`)}return c[0].result}async restoreToOriginalState(){try{V("openDocument",k,JSON.stringify({password:C})),P&&Z();let e=K("get_signatures",{certificate_check_time:"current_time"})[0],t="not_signed"!==e.status;V("saveDocument",S,!1,t,!1,!1,"pdf",!1),V("openDocument",S,JSON.stringify({password:C})),P&&Z()}catch(e){throw Error(`Could not restore backup document: ${e}`)}}async evalFormValuesActions(e){let t=eo().reduce((t,n)=>e.find(({name:e})=>n.formField.name===e)&&"pspdfkit/form-field/text"===n.formField.type?t.concat(n):t,[]);if(R)for(let n=0;n<t.length;n++){let r=t[n].widgets;for(let n=0;n<r.length;n++)await this.preflightWidgetAnnotation(r[n],r[n].pdfObjectId,e.find(e=>t[n].formField.name===e.name)?.value)}let n=K("set_form_values_get_script_changes",{form_values:e});return r(1===n.length,"expected only one response for evalFormValuesActions"),this._processChanges(n[0].changes)}async readFormJSONObjects(){return eo()}async setFormJSONUpdateBatchMode(e){await er(e)}_processChanges(e){return e.map(e=>"pspdfkit/javascript/effects/importIcon"===e.object.type?{...e,object:{...e.object,id:Object.entries(this._pdfObjectIdsForIds).find(([,t])=>t===e.object.annotationID)?.[0]}}:e)}async evalScript(e,t){let n=K("run_pdf_javascript",{pdf_javascript_contents:e,pdf_javascript_form_fqn:t});return r(1===n.length,"expected only one response for evalScript"),this._processChanges(n[0].changes)}async closeDocument(){try{return $=[],C=null,P=!1,ee=null,et=!1,Q=!1,V("closeDocument")}finally{this._pdfObjectIdsForIds={}}}async renderTile(e,t,n,o,a,i,s,c){r(j,D);let l=ec(c,{width:n.width,height:n.height}),d=K("render_tile",{render_annotations:!!(i||s),print_rendering:o,page:e,bitmap_width:n.width,bitmap_height:n.height,bitmap_x:n.left,bitmap_y:n.top,page_width:t.width,page_height:t.height,format:l,render_text:a});return"bitmap"===l&&"OffscreenCanvas"in globalThis?ed({buffer:d[0],width:n.width,height:n.height}):d[0]}async renderAnnotation(e,t,n,r,o,a){return ei({...e,pdfObjectId:this._getPdfObjectIdForObject(e)},t?await p(t):null,n,r,o,a)}async renderPageAnnotations(e,t,n,r,o){return t.map((t,a)=>ei({pdfObjectId:t,pageIndex:e},null,n[a],r[a],ec(o,{width:n[a],height:r[a]})))}async renderDetachedAnnotation(e,t,n,o,a){r(j,D),R&&("pspdfkit/stamp"===e.type||"pspdfkit/text"===e.type)&&await this.preflightAnnotation(e,e.pdfObjectId);let i=t?await p(t):null,s=t?t.type:null,c,l,d=new j.VectorUint8;try{if(null!=i)for(let e=0;e<i.byteLength;e++)d.push_back(i[e]);if((l=W("renderDetachedAnnotation",a,JSON.stringify({...e,pdfObjectId:this._getPdfObjectIdForObject(e),pageIndex:0}),0,n,o,d,s||"")).hasError()||1!==l.getRepliesCount()){let e=l.getErrorMessage(),t=l.getErrorReason();throw Error(t+": "+e)}c=l.getBinaryReply(0).slice(0)}finally{d&&d.delete(),l&&l.delete()}return c}async loadCertificates(e){if(K("load_certificates",{certificates:e}).length>0)throw new n("Internal error while loading certificates")}async getAttachment(e){let t,n,r,o=(await this.getEmbeddedFilesList())?.map(e=>e.id)?.includes(e);try{if(o)K("extract_embedded_file",{id:e,file_path:A}),t=j.FS.readFile(A).buffer;else if((n=W("getAnnotationAttachment",e)).hasError()||1!==n.getRepliesCount()){let e=n.getErrorMessage(),t=n.getErrorReason();throw Error("Error fetching attachment: "+t+", "+e)}else r=JSON.parse(n.getJSONReply(0)).encoding,t=n.getBinaryReply(0).slice(0)}finally{j.FS.analyzePath(A)?.exists&&j.FS.unlink(A),n&&n.delete()}return[t,r]}async textForPageIndex(e){return V("textForPageIndex",e).textBlocks}async textContentTreeForPageIndex(e){return K("get_content_tree",{pageIndex:e})}async annotationsForPageIndex(e){let t=V("annotationsForPageIndex",e);return["rollover","down"].forEach(e=>{t.apstream_variants?.[e]?.forEach(n=>{let r=t.annotations.find(e=>e.pdfObjectId===n);r?r[e]=!0:t.annotations.push({pdfObjectId:n,[e]:!0})})}),t.annotations}async getTabOrder(e){return K("get_annotation_tab_order",{page:e})[0].order.map(e=>({id:Object.entries(this._pdfObjectIdsForIds).find(([t,n])=>n===e)?.[0]||String(e),pdfObjectId:e}))}async setTabOrder(e,t){K("set_annotation_tab_order",{page:e,order:t.map(e=>this._getPdfObjectIdForObject(e))})}async createAnnotation(e,t){r(j,D),r("number"==typeof e.pageIndex,"Annotation must have a pageIndex");let n=e.pdfObjectId,o=t?await p(t):null,a,i=new j.VectorUint8;try{if(null!=o)for(let e=0;e<o.byteLength;e++)i.push_back(o[e]);"pspdfkit/widget"===e.type&&(er(!1),en());let t=("pspdfkit/shape/ellipse"===e.type||"pspdfkit/shape/rectangle"===e.type)&&e.measurementScale?{...e,measurementBBox:e.bbox}:e;a=V("createAnnotation",JSON.stringify({...t,pdfObjectId:null}),i)}finally{i&&i.delete()}return"number"==typeof n&&"number"==typeof this._pdfObjectIdsForIds[n.toString()]&&delete this._pdfObjectIdsForIds[n.toString()],this._pdfObjectIdsForIds[e.id||a.pdfObjectId.toString()]=a.pdfObjectId,e&&this.canPreflightAnnotation(e)&&R&&await this.preflightAnnotation(e,a.pdfObjectId),a.pdfObjectId}async updateAnnotation(e){let t={...e,pdfObjectId:this._getPdfObjectIdForObject(e)};if(r(t.id,"Annotation must have an ID"),r("number"==typeof t.pageIndex,"Annotation must have a pageIndex"),"pspdfkit/widget"===t.type){let e=eo(),n="number"==typeof t.pdfObjectId?t.pdfObjectId.toString():t.id;ea(e.map(e=>e.formField.annotationIds.includes(n)||e.formField.annotationIds.includes(String(t.pdfObjectId))?{...e,widgets:e.widgets.map(e=>e.id===n||String(e.pdfObjectId)===n?t:e)}:e))}else e&&this.canPreflightAnnotation(e)&&R&&await this.preflightAnnotation(e,t.pdfObjectId),V("updateAnnotation",JSON.stringify(t),0,0)}async updateButtonIcon(e,t,n){K("update_annotation",{annotation:{...e,pdfObjectId:this._getPdfObjectIdForObject(e),contentType:n}},t)}async deleteAnnotation(e){if(e.APStreamCache&&await this.updateAnnotation(e),"pspdfkit/widget"===e.type)try{let t=e.id,n=eo();ea(n.map(n=>{if(n.formField.annotationIds.includes(t)||n.formField.annotationIds.includes(String(e.pdfObjectId))){let r,o=n.value;if(("pspdfkit/form-field/checkbox"===n.formField.type||"pspdfkit/form-field/radio"===n.formField.type)&&n.formField.options.length===n.formField.annotationIds.length){let a=n.formField.annotationIds.includes(t)?n.formField.annotationIds.indexOf(t):n.formField.annotationIds.indexOf(String(e.pdfObjectId));(r=n.formField.options.filter((e,t)=>t!==a)).some(e=>e.value===o)||(o="")}let a=n.widgets.filter(e=>t!==e.id),i=n.formField.annotationIds.filter(n=>n!==t&&n!==String(e.pdfObjectId));return a.length>0&&i.length>0?{...n,formField:{...n.formField,annotationIds:i,...r?{options:r}:null},widgets:a,value:o}:null}return n}).filter(Boolean))}catch(e){throw e}else try{K("remove_annotations",{annotation_ids:[this._getPdfObjectIdForObject(e)]})}catch{a(`Removing annotation failed for annotation: ${JSON.stringify(e)}`)}delete this._pdfObjectIdsForIds[e.id||e.pdfObjectId?.toString()],J.delete(e.pdfObjectId)}async createFormField(e,t){let n=eo().concat([{type:"pspdfkit/form-field-with-widgets",formField:e,widgets:t}]),r=et;et&&er(!1),ea(n);let o=eo();r&&er(!0);let a=o.find(t=>t.formField.name===e.name);if(!a)throw Error(`Error creating new form field in ${S}: created form field not found. ${JSON.stringify({type:"pspdfkit/form-field-with-widgets",formField:e,widgets:t})}`);let i=a.widgets.map(e=>(this._pdfObjectIdsForIds[e.id]=e.pdfObjectId,e.pdfObjectId));return"number"==typeof e.pdfObjectId&&"number"==typeof this._pdfObjectIdsForIds[e.pdfObjectId.toString()]&&delete this._pdfObjectIdsForIds[e.pdfObjectId.toString()],this._pdfObjectIdsForIds[e.id||a.formField.pdfObjectId.toString()]=a.formField.pdfObjectId,i}async updateFormField(e,t){let n={...e,pdfObjectId:this._pdfObjectIdsForIds[e.id]||this._getPdfObjectIdForObject(e)},r=eo(),o=r.find(t=>el(t.formField,n)||t.formField.name===e.name);if(!o)throw Error(`Error updating form field with name "${e.name}" in ${S}: form field not found. ${JSON.stringify(r)}`);let a=o.formField.name!==e.name,i=null;if(a&&"pspdfkit/form-field/radio"===n.type){let o=e.name,a=r.find(e=>e.formField.name===o);a&&"pspdfkit/form-field/radio"===a.formField.type&&(n={...n,annotationIds:[...n.annotationIds,...a.formField.annotationIds],options:[...n.options,...a.formField.options]},t=[...t,...a.widgets],i=a)}ea(r.map(r=>{if(i&&i.formField.pdfObjectId===r.formField.pdfObjectId)return null;if(!el(r.formField,n)&&r.formField.name!==e.name)return r;{let o={type:"pspdfkit/form-field-with-widgets",formField:{...r.formField,...n},widgets:t.reduce((e,t)=>[...e,{...r.widgets.find(e=>e.id===t.id||e.pdfObjectId===t.pdfObjectId),...t}],[]),..."u">typeof r.value?{value:r.value}:null};return e.flags||delete o.formField.flags,o}}).filter(Boolean));let s=eo().find(t=>t.formField.name===e.name);if(!s)throw Error(`Error updating form field "${e.name}" in ${S}: updated form field not found. ${JSON.stringify({type:"pspdfkit/form-field-with-widgets",formField:e,widgets:t})}`);s.formField.pdfObjectId!==n.pdfObjectId&&(this._pdfObjectIdsForIds[n.id]=s.formField.pdfObjectId),o?.widgets.forEach(e=>{t.some(t=>t.id===e.id)||delete this._pdfObjectIdsForIds[e.id]})}async deleteFormField(e){let t=eo(),n=t.find(t=>t.formField.name===e.name);if(!n)return;ea(t.filter(t=>t.formField.name!==e.name));let r=eo().find(t=>t.formField.name===e.name);if(r)throw Error(`Error deleting form field with name "${e.name}" in ${S}: form field still present. ${JSON.stringify(r)}`);n.widgets.forEach(e=>{delete this._pdfObjectIdsForIds[e.id]})}async deleteFormFieldValue(e){ea(eo().map(t=>t.formField.name===e?{formField:t.formField,widgets:t.widgets,type:t.type}:t))}canPreflightAnnotation(e){return"pspdfkit/text"===e.type||"pspdfkit/stamp"===e.type}async preflightAnnotation(e,t){if(!this.canPreflightAnnotation(e))return;let n="pspdfkit/stamp"===e.type?e.title:e.text?.value;if("number"==typeof t&&!n){J.delete(t);return}n&&await this.preflightRenderAnnotationText(n,t,e.pageIndex,{...e,pdfObjectId:this._getPdfObjectIdForObject(e),pageIndex:0})}async preflightWidgetAnnotation(e,t,n){if(!n&&"number"==typeof t){J.delete(t);return}n&&await this.preflightRenderAnnotationText(n,t,e.pageIndex)}async createBookmark(e){try{K("append_bookmarks",{bookmarks:[e]})}catch(e){throw Error(`Error creating new bookmark in ${S}: ${e.message}`)}}async updateBookmark(e){try{K("remove_bookmarks",{bookmarkIds:[e.id??e.pdfBookmarkId]}),K("append_bookmarks",{bookmarks:[e]})}catch(e){throw Error(`Error updating bookmark in ${S}: ${e.message}`)}}async deleteBookmark(e){try{K("remove_bookmarks",{bookmarkIds:[e]})}catch(e){throw Error(`Error deleting bookmark in ${S}: ${e.message}`)}}async getTextFromRects(e,t){return V("getTextFromRects",e,JSON.stringify(t.map(e=>[e.left,e.top,e.width,e.height]))).text}async search(e,t,n,r,o=f.TEXT){return K("search",{query:e,start_index:t,limit:n,case_sensitive:r,search_type:o})}async parseXFDF(e,t){try{let n=K("convert_xfdf_to_instant_json",{ignore_page_rotation:t},e);return function(e){try{let t=new TextDecoder().decode(e);return JSON.parse(t)}catch(e){throw e}}(n[0])}catch(e){throw e}}async getEmbeddedFilesList(){return K("list_embedded_files")[0].embeddedFiles||null}async getMeasurementSnappingPoints(e){let t=K("get_snapping_points",{page:e});return t[0].snappingPoints?function(e){let t=[...e.endpoints,...e.intersections,...e.midpoints],n=[];for(let e=0;e<t.length;e+=2){let r=[t[e],t[e+1]];n.push(r)}return n.sort((e,t)=>e[0]==t[0]?e[1]-t[1]:e[0]-t[0])}(t[0].snappingPoints):null}async getSecondaryMeasurementUnit(){try{return K("get_secondary_measurement_unit")[0]||null}catch(e){throw Error(`Error getting secondary measurement: ${e.message}`)}}async compareDocuments(e){try{r(e.originalDocument.arrayBuffer,"Original document arrayBuffer is missing"),r(e.changedDocument.arrayBuffer,"Changed document arrayBuffer is missing"),j.FS.writeFile("documentA.pdf",new Uint8Array(e.originalDocument.arrayBuffer)),j.FS.writeFile("documentB.pdf",new Uint8Array(e.changedDocument.arrayBuffer));let t={originalDocument:{...e.originalDocument,filePath:"documentA.pdf"},changedDocument:{...e.changedDocument,filePath:"documentB.pdf"},comparisons:[e.comparisonOperation]};return K("document_comparison",t)||null}catch(e){throw Error(`Error comparing documents: ${e.message}`)}}async setSecondaryMeasurementUnit(e){try{K("set_secondary_measurement_unit",e?{unitTo:e?.unitTo,precision:e?.precision}:null)}catch{a("Error setting secondary measurement unit")}}async getMeasurementScales(){try{return K("get_measurement_content_formats")[0]||null}catch(e){throw Error(`Error getting measurement scales: ${e.message}`)}}async removeMeasurementScale(e){try{K("remove_measurement_content_format",{measurementContentFormat:s(e)})}catch(t){throw Error(`Error removing ${e.name} measurement scale: ${t.message}`)}}async addMeasurementScale(e){try{K("add_measurement_content_format",{measurementContentFormat:s(e)})}catch(t){throw Error(`Error adding ${e.name} measurement scale: ${t.message}`)}}async getAnnotationsByScale(e){try{return K("get_annotations_for_measurement_content_format",{measurementContentFormat:s(e)})||null}catch(e){throw e}}async exportFile(e,t,n,o,a,i,s){let c={mimeType:"application/pdf",extension:"pdf"};try{let r=K("save_document",{file_path:k,format:o,flatten_annotations:e,save_incrementally:t,apply_redactions:!1,save_for_printing:n,remove_all_annotations:a,preserve_change_tracker_state:i,...s?{user_password:s.userPassword,owner_password:s.ownerPassword,document_permissions:function(e){let t=[];for(let n=0;n<e.length;n++)t.push(z[e[n]]);return t}(s.documentPermissions)}:null})[0];r.format&&(c={mimeType:r.format.mime_type,extension:r.format.extension})}catch(e){throw Error(`Error saving to ${k}: ${e.message}`)}return r(j,D),[j.FS.readFile(k).buffer,c]}async importXFDF(e,t,n){$.push({source:e,keepCurrentAnnotations:t}),t||function(e=[],t=[]){e.push("pspdfkit/widget"),V("removeAllAnnotations",JSON.stringify(e),JSON.stringify(t))}(),V("importXFDF",e,n)}async exportXFDF(e){return V("exportXFDF",[],[],e).XFDF}async importInstantJSON(e){V("importInstantDocumentJSON",JSON.stringify(e))}async exportInstantJSON(e){let t=et;et&&er(!1);let n=V("exportInstantDocumentJSON","number"==typeof e?e:-1);return t&&er(!0),JSON.parse(n.InstantDocumentJSON)}async getDocumentOutline(){let e=K("get_outline");return r(1===e.length,"expected only one response for getDocumentOutline"),e[0].outline||[]}async setDocumentOutline(e){return K("set_outline",{outline:e})}async getPageGlyphs(e){return K("get_glyphs",{page:e})[0].glyphs||[]}async onKeystrokeEvent(e){let t=K("on_keystroke_event",{pdf_javascript_event:e});r(1===t.length,"expected only one response for onKeystrokeEvent");let n=t[0].changes||[];return r(n.length>0&&4===n[0].change_type,"expected onKeystrokeEvent to return at least one JavaScript Event change."),n}async version(){return V("PSPDFKitVersion").version}getImportedXFDF(){return $}async applyRedactions(){try{V("saveDocument",S,!1,!1,!0,!1,"pdf",!1)}catch(e){throw Error(`Error applying redactions and saving to ${S}: ${e.message}`)}}async clearAPStreamCache(){V("clearAPStreamCache")}async setComparisonDocument(e,t){this.comparisonDocuments[e]=t||(await this.exportFile(!1,!1,!1,"pdf",!1,!1))[0]}async openComparisonDocument(e){return r(this.comparisonDocuments[e]),e===this.lastOpenedComparisonDocument||e===m.documentA&&null===this.lastOpenedComparisonDocument&&this.persistedOpenDocument instanceof ArrayBuffer?null:(this.lastOpenedComparisonDocument=e,this.openDocument(this.comparisonDocuments[e],this.persistedOpenDocument===e?this.persistedOpenDocumentPassword:void 0))}async documentCompareAndOpen(e){r(this.comparisonDocuments[m.documentA]&&this.comparisonDocuments[m.documentB],"One or both comparison input documents are missing.");let t=`${m.documentA}.pdf`,n=`${m.documentB}.pdf`;return j.FS.writeFile(t,new Uint8Array(this.comparisonDocuments[m.documentA])),j.FS.writeFile(n,new Uint8Array(this.comparisonDocuments[m.documentB])),K("comparison",{documentA:{strokeColor:e.documentA.strokeColor,pageIndex:e.documentA.pageIndex,filePath:t},documentB:{strokeColor:e.documentB.strokeColor,pageIndex:e.documentB.pageIndex,filePath:n},options:{...e.options,outputFilePath:"output.pdf"}}),await this.closeDocument(),this.comparisonDocuments[m.result]=j.FS.readFile("output.pdf").buffer,this.lastOpenedComparisonDocument=m.result,this.openDocument(this.comparisonDocuments[m.result],void 0)}async persistOpenDocument(e){if(e)this.persistedOpenDocument=e;else try{this.persistedOpenDocument=(await this.exportFile(!1,!1,!1,"pdf",!1,!0))[0]}catch(e){throw Error(`Error trying to persist a copy of the currently opened document: ${e.message}`)}this.persistedOpenDocumentPassword=C}async cleanupDocumentComparison(){r(this.persistedOpenDocument,"No persisted previous document key or array buffer is available.");let e=this.persistedOpenDocument instanceof ArrayBuffer?this.persistedOpenDocument:this.comparisonDocuments[this.persistedOpenDocument];r(e,"No persisted previous array buffer is available.");try{await this.closeDocument()}catch(e){throw Error(`Error trying to close the current document: ${e.message}`)}let t=this.openDocument(e,this.persistedOpenDocumentPassword);return this.persistedOpenDocument=null,this.persistedOpenDocumentPassword=null,this.lastOpenedComparisonDocument=null,this.comparisonDocuments={},t}_getPdfObjectIdForObject(e){return"number"==typeof e.pdfObjectId?e.pdfObjectId:this._pdfObjectIdsForIds[e.id]}async contentEditorEnter(){K("content_editing/enter")}async contentEditorExit(){K("content_editing/exit")}async contentEditorGetTextBlocks(e){let t=K("content_editing/get_text_blocks",{pageIndex:e});return r(1===t.length,"expected only one response for getTextBlocks"),t[0]}async contentEditorDetectParagraphs(e){let t=K("content_editing/detect_paragraphs",{pageIndex:e});return r(1===t.length,"expected only one response for detectParagraphs"),t[0]}async contentEditorRenderTextBlock(e,t,n){let o=K("content_editing/render_text_block",{textBlockId:e,renderTextBlockParams:t,externalControlState:n});return r(2===o.length,"expected only two responses for renderTextBlock. ArrayBuffer and Size info."),{imageBuffer:o[1],displayRect:o[0].displayRect}}async contentEditorSetTextBlockCursor(e,t,n,o){let a=K("content_editing/set_cursor",{textBlockId:e,offset:t,selectText:n,externalControlState:o});return r(1===a.length,"expected only one response for setTextBlockCursor"),a[0]}async contentEditorMoveTextBlockCursor(e,t,n,o){let a=K("content_editing/move_cursor",{textBlockId:e,movement:t,selectText:n,externalControlState:o});return r(1===a.length,"expected only one response for moveTextBlockCursor"),a[0]}async contentEditorInsertTextBlockString(e,t,n,o){let a=K("content_editing/insert_text",{textBlockId:e,cluster:t,text:n,externalControlState:o});return r(1===a.length,"expected only one response for insertTextBlockString"),a[0]}async contentEditorInsertTextBlockContentRef(e,t,n,o){let a=K("content_editing/insert_content_ref",{textBlockId:e,cluster:t,contentRef:n,externalControlState:o});return r(1===a.length,"expected only one response for contentEditorInsertTextBlockContentRef"),a[0]}async contentEditorCreateTextBlock(e){let t=K("content_editing/create_text_block",{pageIndex:e});return r(1===t.length,"expected only one response for contentEditorCreateTextBlock"),t[0]}async contentEditorDeleteTextBlockRange(e,t,n){let o=K("content_editing/delete_range",{textBlockId:e,range:t,externalControlState:n});return r(1===o.length,"expected only one response for deleteTextBlockRange"),o[0]}async contentEditorLayoutTextBlock(e,t,n,o){let a=K("content_editing/layout",{textBlockId:e,cursor:t,selection:n,externalControlState:o});return r(1===a.length,"expected only one response for layoutTextBlock"),a[0]}async contentEditorDeleteTextBlockString(e,t,n){let o=K("content_editing/delete_cluster",{textBlockId:e,direction:t,externalControlState:n});return r(1===o.length,"expected only one response for deleteTextBlockString"),o[0]}async contentEditorSetTextBlockSelection(e,t,n){let o=K("content_editing/set_selection",{textBlockId:e,mode:t,externalControlState:n});return r(1===o.length,"expected only one response for setTextBlockSelection"),o[0]}async contentEditorSetTextBlockSelectionRange(e,t,n,o,a){let i=K("content_editing/set_selection_range",{textBlockId:e,begin:t,end:n,mode:o,externalControlState:a});return r(1===i.length,"expected only one response for setTextBlockSelection"),i[0]}async contentEditorTextBlockUndo(e,t){let n=K("content_editing/undo",{textBlockId:e,externalControlState:t});return r(1===n.length,"expected only one response for textBlockUndo"),n[0]}async contentEditorTextBlockRedo(e,t){let n=K("content_editing/redo",{textBlockId:e,externalControlState:t});return r(1===n.length,"expected only one response for textBlockRedo"),n[0]}async contentEditorTextBlockRestore(e,t,n){let o=K("content_editing/restore",{textBlockId:e,version:t,externalControlState:n});return r(1===o.length,"expected only one response for textBlockRestore"),o[0]}async contentEditorTextBlockApplyFormat(e,t,n,o){let a=K("content_editing/apply_format",{textBlockId:e,range:t,formatModifications:n,externalControlState:o});return r(1===a.length,"expected only one response for textBlockApplyFormat"),a[0]}async contentEditorGetAvailableFaces(){let e=K("content_editing/available_faces");return r(1===e.length,"expected only one response for available_faces"),e[0]}async contentEditorSave(e){let t;try{t=K("content_editing/save_to_document",{path:S,textBlockSaveInfos:e})}catch(e){throw Error(`Error saving to ${k}: ${e.message}`)}return t}async getOCGs(){return K("ocg/get_ocgs")[0].ocgs}async getOCGVisibilityState(){return{visibleLayerIds:K("ocg/get_visibility_state")[0].state.visible}}async setOCGVisibilityState(e){return K("ocg/set_visibility_state",{state:{visible:e.visibleLayerIds}})}recycle(){}destroy(){}};self.onmessage=async({data:e})=>{let t,n;try{let r=await eu[e.action](...e.args);if(t={id:e.id,result:r},Array.isArray(r)){let e=r.filter(e=>e instanceof ArrayBuffer);e.length>0&&(n=e)}r instanceof ArrayBuffer&&(n=[r])}catch(o){let r=[...e.args].filter(e=>e instanceof ArrayBuffer);r.length>0&&(n=r),i("[PSPDFKit Internal Debug]",o.message,o.stack),t={id:e.id,error:o.message||o.toString(),callArgs:e.args}}self.postMessage(t,n)};